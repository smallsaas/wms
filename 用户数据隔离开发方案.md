## 用户数据隔离开发方案
#### 用uaas进行用户数据隔离开发
> 添加maven依赖
> 提示：不能依赖crud-dev，仅用于测试，不能同时依赖
```shell
$ cat ./wms/product/pom.xml
<dependency>
    <groupId>com.jfeat</groupId>
    <artifactId>uaas</artifactId>
    <version>2.1.0</version>
</dependency>
<dependency>
    <groupId>com.jfeat</groupId>
    <artifactId>crud-runtime</artifactId>
    <version>0.0.1</version>
</dependency>
<!--组织用户测试数据-->
<dependency>
    <groupId>com.jfeat</groupId>
    <artifactId>uaas-dev-org</artifactId>
    <version>1.0.0</version>
</dependency>
```
#### 参考env-test-saas的数据隔离方案进行修改
>model实体类添加orgId和orgTag字段,例如
```shell
$ cat ./Product.java
@TableName("t_product")
public class Product extends Model<Product> {
    ...
    /**
	 * 用于隔离的组织id, 由crud-plus维护
	 */
	@TableField("org_id")
	private  Long orgId;
	/**
	 * 用于隔离的组织标识, 参考 docker而定
	 */
	@TableField("org_tag")
	private String orgTag;
    ...
     }
```
>Mapper.xml添加orgId和orgTag字段映射，例如
```shell
$ cat ./ProductMapper.xml
<?xml version="1.0" encoding="UTF-8"?>
...
<resultMap id="BaseResultMap" type="com.jfeat.am.module.product.services.persistence.model.Product">
<result column="org_id" property="orgId" />
<result column="org_tag" property="orgTag" />
...
</resultMap>
 <!-- 通用查询结果列 -->
<sql id="Base_Column_List">
    id, org_id AS orgId, org_tag AS orgTag, product_category_id AS productCategoryId, supplier_id AS supplierId, product_code AS productCode, name, english_name AS englishName, weight, readjust_cost_price AS readjustCostPrice, product_standard AS productStandard, price, suggested_price AS suggestedPrice, cost_price AS costPrice, specification, quantities, stock_cost AS stockCost, purchase_advance AS purchaseAdvance, status, sort_value AS sortValue, search_key_word AS searchKeyWord, bar_code AS barCode, create_time AS createTime, update_time AS updateTime, description, field1, volume, spec, field4, field5
</sql>
</mapper>
```
>Dao.xml添加orgId字段查询，例如
```shell
$ cat ./QueryProductDao.xml
<?xml version="1.0" encoding="UTF-8"?>
<sql id="QueryOwnedOrgIds">
    SELECT children.id FROM t_sys_org, t_sys_org as children WHERE t_sys_org.left_num &lt;= children.left_num AND
    t_sys_org.right_num >= children.left_num and t_sys_org.id=#{record.orgId} order by t_sys_org.node_level ASC
</sql>
<resultMap id="BaseResultMap" type="com.jfeat.am.module.product.services.domain.model.ProductRecord">
<id column="id" property="id"/>
<result column="org_id" property="orgId" />
<result column="org_tag" property="orgTag" />
...
</resultMap>
<select id="findProductPage" resultMap="BaseResultMap" parameterType="ProductRecord">
SELECT
t_product.*
FROM t_product left join t_sys_user on t_product.org_id = t_sys_user.org_id
<if test="record.orgId > 0">
    ,(<include refid="QueryOwnedOrgIds"></include>) AS ownedOrgIds
</if>
WHERE 1=1
<if test="record.orgId > 0">
    AND t_sys_user.org_id = ownedOrgIds.id
</if>
</select>
</mapper>
```
>修改Endpoint类查询列表方法，添加orgId参数，例如
```shell
 $ cat ./ProductEndpoint.java
public class ProductEndpoint   {
 public Tip queryProducts(Page<ProductRecord> page,
                          ...
                         @RequestParam(name = "orgId", required = false) Long orgId,
                          ...
                             ) {
        ...
        ProductRecord record = new ProductRecord();
        record.setOrgId(JWTKit.getOrgId());
        ...
        page.setRecords(queryProductDao.findProductPage(page, orgId,record, orderBy));
        return SuccessTip.create(page);
    }
}
 ```
>修改Dao接口查询列表方法，添加orgId参数，例如
```shell
public interface QueryProductDao extends BaseMapper<ProductRecord> {
    List<ProductRecord> findProductPage(Page<ProductRecord> page,@Param("orgId") Long orgId, @Param("record") ProductRecord record, @Param("orderBy") String orderBy);
}
```
>修改完成后，运行程序

>启动product主启动类 Product is success!表示启动成功

>提示：启动前请设置jdk11环境
```shell
[main] com.jfeat.AmApplication: Started AmApplication in 66.206 seconds (JVM running for 69.943)
[main] com.jfeat.AmApplication: SB Product is success!
```

#### 然后进行用户数据测试