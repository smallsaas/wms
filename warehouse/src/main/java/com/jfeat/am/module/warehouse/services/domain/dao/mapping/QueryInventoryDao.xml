<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.jfeat.am.module.warehouse.services.domain.dao.QueryInventoryDao">
    <sql id="Base_Column_List">
        wms_inventory.*
    </sql>

    <resultMap id="BaseResultMap" type="com.jfeat.am.module.warehouse.services.domain.model.InventoryRecord">
        <id column="id" property="id" />
        <result column="warehouse_id" property="warehouseId" />
        <result column="slot_id" property="slotId" />
        <result column="max_inventory" property="maxInventory" />
        <result column="min_inventory" property="minInventory" />
        <result column="sku_id" property="skuId" />
        <result column="valid_sku" property="validSku" />
        <result column="advance_quantities" property="advanceQuantities" />
        <result column="transmit_quantities" property="transmitQuantities" />

        <result column="skuName" property="skuName" />
        <result column="skuBarcode" property="skuBarcode" />
        <result column="skuCode" property="skuCode" />
        <result column="skuUnit" property="skuUnit" />
        <result column="warehouseName" property="warehouseName" />

    </resultMap>


    <select id="findInventoryPage" resultType="InventoryRecord" parameterType="InventoryRecord">
        SELECT

                wms_inventory.*,
                t_sku_product.sku_name as skuName,
                t_sku_product.bar_code as skuBarcode,
                t_sku_product.sku_code as skuCode,
                t_sku_product.field1 as skuUnit,
                wms_warehouse.warehouse_name
        FROM wms_inventory
        left join t_sku_product on t_sku_product.id = wms_inventory.sku_id
        left join wms_warehouse on wms_warehouse.id = wms_inventory.warehouse_id
        WHERE 1=1
        <if test="record.id != null and record.id>0 ">
            AND wms_inventory.id LIKE CONCAT('%',#{record.id},'%')
        </if>

        <if test="warehouseName != null and warehouseName!= ''">
            AND wms_warehouse.warehouse_name = #{warehouseName}
        </if>

        <if test="skuName != null and skuName!= '' ">
            AND t_sku_product.sku_name LIKE CONCAT('%',#{skuName},'%')
        </if>

        <if test="record.warehouseId != null and record.warehouseId>0 ">
            AND wms_inventory.warehouse_id LIKE CONCAT('%',#{record.warehouseId},'%')
        </if>

        <if test="record.slotId != null and record.slotId>0 ">
            AND wms_inventory.slot_id LIKE CONCAT('%',#{record.slotId},'%')
        </if>

        <if test="record.maxInventory != null and record.maxInventory>0 ">
            AND wms_inventory.max_inventory LIKE CONCAT('%',#{record.maxInventory},'%')
        </if>

        <if test="record.minInventory != null and record.minInventory>0 ">
            AND wms_inventory.min_inventory LIKE CONCAT('%',#{record.minInventory},'%')
        </if>

        <if test="record.skuId != null and record.skuId>0 ">
            AND wms_inventory.sku_id LIKE CONCAT('%',#{record.skuId},'%')
        </if>

        <if test="record.validSku != null and record.validSku>0 ">
            AND wms_inventory.valid_sku LIKE CONCAT('%',#{record.validSku},'%')
        </if>

        <if test="record.advanceQuantities != null and record.advanceQuantities>0 ">
            AND wms_inventory.advance_quantities LIKE CONCAT('%',#{record.advanceQuantities},'%')
        </if>

        <if test="record.transmitQuantities != null and record.transmitQuantities>0 ">
            AND wms_inventory.transmit_quantities LIKE CONCAT('%',#{record.transmitQuantities},'%')
        </if>
    </select>


    <!-- 出入库记录 -->

    <select id="skuStorageDetails" resultType="com.jfeat.am.module.warehouse.services.domain.model.SkuStorageDetails">

        SELECT
        sin.sku_id AS skuId,
        sin.type,
        sin.relation_code as relationCode,
        sin.transaction_sku_price AS transactionSkuPrice,
        sin.transaction_quantities AS transactionQuantities,
        sin.transaction_time AS transactionTime,
        sin.after_transaction_quantities AS validValue,
        t_sku_product.sku_name AS skuName,
        t_sku_product.bar_code AS skuBarcode,
        t_sku_product.sku_code AS skuCode,
        t_sku_product.field1 AS skuUnit,
        wms_warehouse.warehouse_name AS warehouseName,
        wms_storage_in.transaction_type AS transactionType,
        wms_storage_in.transaction_code AS transactionCode,
        'sin' recordType


        FROM
        wms_storage_in_item sin
        LEFT JOIN wms_storage_in ON sin.storage_in_id = wms_storage_in.id
        LEFT JOIN t_sku_product ON t_sku_product.id = sin.sku_id
        LEFT JOIN wms_warehouse ON wms_warehouse.id = wms_storage_in.warehouse_id

        WHERE
        1 = 1
        AND t_sku_product.id = #{skuId}
        AND wms_warehouse.warehouse_name = #{warehouseName}
        AND sin.type != 'Procurement'

        UNION
        SELECT

        sout.sku_id AS skuId,
        NULL AS type,
        sout.relation_code as relationCode,
        sout.transaction_sku_price AS transactionSkuPrice,
        sout.transaction_quantities AS transactionQuantities,
        sout.transaction_time AS transactionTime,
        sout.after_transaction_quantities AS validValue,
        t_sku_product.sku_name AS skuName,
        t_sku_product.bar_code AS skuBarcode,
        t_sku_product.sku_code AS skuCode,
        t_sku_product.field1 AS skuUnit,
        wms_warehouse.warehouse_name AS warehouseName,
        wms_storage_out.transaction_type AS transactionType,
        wms_storage_out.transaction_code AS transactionCode,
        'sout' recordType
        FROM
        wms_storage_out_item sout
        LEFT JOIN wms_storage_out ON sout.storage_out_id = wms_storage_out.id
        LEFT JOIN t_sku_product ON t_sku_product.id = sout.sku_id
        LEFT JOIN wms_warehouse ON wms_warehouse.id = wms_storage_out.warehouse_id

        WHERE
        1 = 1
        AND t_sku_product.id = #{skuId}
        AND wms_warehouse.warehouse_name = #{warehouseName}

        ORDER BY transactionTime DESC
    </select>

    <select id="skuStorageOutDetails" resultType="com.jfeat.am.module.warehouse.services.domain.model.SkuStorageDetails">

        SELECT

        sout.sku_id AS skuId,
        NULL AS type,
        sout.relation_code as relationCode,
        sout.transaction_sku_price AS transactionSkuPrice,
        sout.transaction_quantities AS transactionQuantities,
        sout.transaction_time AS transactionTime,
        sout.after_transaction_quantities AS validValue,
        t_sku_product.sku_name AS skuName,
        t_sku_product.bar_code AS skuBarcode,
        t_sku_product.sku_code AS skuCode,
        t_sku_product.field1 AS skuUnit,
        wms_warehouse.warehouse_name AS warehouseName,
        wms_storage_out.transaction_type AS transactionType,
        wms_storage_out.transaction_code AS transactionCode
        FROM
        wms_storage_out_item sout
        LEFT JOIN wms_storage_out ON sout.storage_out_id = wms_storage_out.id
        LEFT JOIN t_sku_product ON t_sku_product.id = sout.sku_id
        LEFT JOIN wms_warehouse ON wms_warehouse.id = wms_storage_out.warehouse_id

        WHERE
        1 = 1
        AND t_sku_product.id = #{skuId}
        AND wms_warehouse.warehouse_name = #{warehouseName}

        ORDER BY transactionTime DESC


    </select>


    <select id="skuStorageInDetails" resultType="com.jfeat.am.module.warehouse.services.domain.model.SkuStorageDetails">

        SELECT
        sin.sku_id AS skuId,
        sin.type,
        sin.relation_code as relationCode,
        sin.transaction_sku_price AS transactionSkuPrice,
        sin.transaction_quantities AS transactionQuantities,
        sin.transaction_time AS transactionTime,
        sin.after_transaction_quantities AS validValue,
        t_sku_product.sku_name AS skuName,
        t_sku_product.bar_code AS skuBarcode,
        t_sku_product.sku_code AS skuCode,
        t_sku_product.field1 AS skuUnit,
        wms_warehouse.warehouse_name AS warehouseName,
        wms_storage_in.transaction_type AS transactionType,
        wms_storage_in.transaction_code AS transactionCode

        FROM
        wms_storage_in_item sin
        LEFT JOIN wms_storage_in ON sin.storage_in_id = wms_storage_in.id
        LEFT JOIN t_sku_product ON t_sku_product.id = sin.sku_id
        LEFT JOIN wms_warehouse ON wms_warehouse.id = wms_storage_in.warehouse_id

        WHERE
        1 = 1
        AND t_sku_product.id = #{skuId}
        AND wms_warehouse.warehouse_name = #{warehouseName}
        AND sin.type != 'Procurement'

    </select>
</mapper>